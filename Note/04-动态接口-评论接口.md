很多地方都会用到验证用户令牌的功能，将它抽取到中间件中。

将验证通过的 user 信息，保存到 ctx.user 中。

---

在 postman 中，别写代码，将 token 保存到全局变量中。

```js
const res = pm.response.json()
pm.globals.set('token', res.data.token)
```

---

在 app/index.js 中，自动加载 router 目录下，所有的路由。

在 router 目录下，创建 index.js，在其中做自动化操作。

---

发布动态内容。

创建 moment 表。

创建 moment.router.js 文件，在其中编写路由。

验证请求的令牌。

创建 moment.controller.js 文件，在其中编写

> 为 koa-controller 设置代码片段
>
> 为 koa-service 设置代码片段，用于 koa 中的数据库操作。

---

查询动态。

插入测试数据。

查询动态列表时，不需要验证用户身份，即令牌。

进行分页查询。

- 预处理语句中，传入的 offset 和 limit 是字符串类型。
- 使用 JSON_OBJECT 函数，用于将 user 信息，查询为对象形式。



查询动态详情。

---

修改动态内容

只有登录的用户，才能修改，验证用户令牌。

每个用户，只能修改自己的动态。这时，需要做权限管理。

创建 middleware/permission.middleware.js 文件。在其中，验证用户是否有权限。

创建 service/permission.service.js 文件，在其中，编写数据库操作。

在 handle-error.js 中，处理错误。



在操作数据库修改动态之前，可验证动态是否存在，更严谨。

---

删除动态

> delete 是 js 中的关键字，不要作为函数的名称

同样的，只能删除自己的数据，进行用户权限验证。

---

重构代码；

提高 middleware/permission.middleware.js 中，verfyMomentPermission 函数的通用性。

方案一：使用闭包，柯里化，传入表名。

方案二：获取动态路由参数的名称，根据该名称验证。

---

发表评论

创建评论表 comment

表中 comment_id 字段，表示评论的是哪条评论。

userId 可以从请求令牌中，直接获取。



回复评论